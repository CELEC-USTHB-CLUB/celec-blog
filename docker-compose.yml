version: "3"
networks:
  celec-blog-network:
services:
 imgproxy:
    image: darthsim/imgproxy
    environment:  
      IMGPROXY_LOCAL_FILESYSTEM_ROOT: "/src"
      IMGPROXY_KEY: "80e2aa39069cd9a46d6006dde409ff24463c274510df5c8f143467064e5c78c1c1a88a04ba3714d44bb118072b86b0ab3cb83835bb5d8bf23a282c5ac3a760b2"
      IMGPROXY_SALT: "406aae6e2d49d00f6b33d885a35f1369d14fe7af492a2705a7f23ea56484e0e879ce9e85000c88bd6ab0ba3c0cc5aba901577ebd36461b3fb69925c389aca3f7"
      IMGPROXY_CACHE_CONTROL_PASSTHROUGH: 1
      IMGPROXY_MAX_SRC_RESOLUTION: 999999
      IMGPROXY_USE_ETAG: 1
    volumes:
      - ./src:/src
    networks:
     - celec-blog-network
 varnish:
    image: varnish:stable
    container_name: varnish
    volumes:
      - "./varnish/default.vcl:/etc/varnish/default.vcl"
    ports:
      - "7000:80"
    tmpfs:
      - /var/lib/varnish:exec
    environment:
      - VARNISH_SIZE=2G  
    command: "-p default_keep=300"
    networks:
      - celec-blog-network
    depends_on:
      - "php-apache-environment"
 php-apache-environment:
  networks:
   - celec-blog-network
  container_name: php-blog-apache
  build:
   context: ./php
   dockerfile: Dockerfile
  volumes: 
   - ./src/:/var/www/html/
   - ./php/config.ini:/usr/local/etc/php/conf.d/uploads-config.ini
   - ./apache/httpd.conf:/usr/local/apache2/conf/httpd.conf
 mariadb:
  container_name: mariadb-celec-blog
  networks:
   - celec-blog-network
  image: mariadb
  environment:
   MARIADB_ROOT_PASSWORD: root
  ports:
   - "7306:3306"

